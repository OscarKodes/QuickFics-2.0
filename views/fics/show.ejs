<%- include ../partials/header %>

<!-- Author control panel -->
<% if (currentUser && currentUser._id.equals(fic.author._id)) { %>
  <% let currPage = "ficPage" %>
  <% include ../partials/authorControlPanel %>
<% } %>

  <!-- Fic Heading -->
  <div class="fic-header text-center bg-white shadow-sm pt-2 pb-4">
    <h1 class="display-3 mt-4 mb-3">
      <%= fic.title %>
    </h1>

    <!-- Show Fic USER CONTROL PANEL -->
    <div class="user-control-panel shadow-sm mb-3">

        <% if (currentUser && currentUser.savedFics.includes(fic._id)) { %>
          <form class="d-inline" action="/savedfics/<%= fic._id %>?_method=DELETE" method="post">
            <button class="user-control-btn saved-fic-btn" type="submit">
              <i class="fas fa-bookmark mr-2"
                SameSite=None Secure></i>Fic Saved!
            </button>
          </form>
        <% } else { %>
          <form class="d-inline" action="/savedFics" method="post">
            <input class="d-none" type="text" name="fic_id" value="<%= fic._id %>">
            <button class="user-control-btn" type="submit">
              <i class="fas fa-bookmark mr-2"
                SameSite=None Secure></i>Save Fic
            </button>
          </form>
        <% } %>
      <a class="user-control-btn"
        href="/fics/<%= fic._id %>/chars">
        <i class="fas fa-users mr-2"
          SameSite=None Secure></i>See Characters
      </a>
      <!-- Copy to Clipboard button -->
      <%- include ../partials/copyToClipBoard %>
    </div> <!-- Closing tag for user control panel -->

    <div class="fic-data">
      <p>
        Author:
        <a class="text-decoration-none h6" href="/user/<%= fic.author._id %>">
          <%=fic.author.name ? fic.author.name : fic.author.username %>
        </a>
      </p>
      <p>
        Created:
        <em>
          <%=fic.dateCreated.toString().slice(4, 15) %>
        </em>
      </p>
      <p>
        Total Stars: <%=fic.totalLikes%>
      </p>
    </div>

    <p class="my-4">
      <%= fic.description %>
    </p>

  </div> <!-- Closing tag for fic heading -->

  <!-- Start Reading Button -->
  <div class="text-center mt-4">
    <% if (fic.eps.length > 0) { %>
      <a class="btn btn-primary btn-xl shadow-lg" href="/fics/<%= fic._id %>/eps/1">
        Start Reading
      </a>
    <% } else { %>
      <p>There are currently no episodes for this Fic.</p>
    <% } %>
  </div>


  <div class="text-center bg-light border rounded m-3 shadow-sm overflow-hidden">
    <h2 class="my-4">Episode List</h2>

      <table class="table">
        <thead>
          <th>Ep. No.</th>
          <th>Title</th>
          <% if (currentUser && currentUser._id.equals(fic.author._id)) { %>
            <th>Edit</th>
          <% } %>
          <th>Stars</th>
          <th>Created</th>
          <% if (currentUser && currentUser._id.equals(fic.author._id)) { %>
            <th>Delete</th>
          <% } %>
        </thead>
        <tbody>
        <% fic.eps.forEach(function(ep, i){ %>
              <tr>
                <td><%= i + 1 %></td>
                <td>
                  <a class="text-primary text-decoration-none" href="/fics/<%= fic._id %>/eps/<%= i + 1 %>">
                    <em><strong><%= ep.title %></strong></em>
                  </a>
                </td>
                <% if (currentUser && currentUser._id.equals(fic.author._id)) { %>
                  <td>
                    <a class="btn btn-outline-primary btn-sm border-0" href="/fics/<%=fic._id%>/eps/<%= i + 1 %>/edit">
                      <i class="fas fa-edit fa-lg pl-1"
                        SameSite=None Secure></i></a>
                  </td>
                <% } %>
                <td><%=ep.likes.length%></td>
                <td><%=ep.dateCreated.toLocaleDateString()%></td>
                <% if (currentUser && currentUser._id.equals(fic.author._id)) { %>
                  <td>
                    <a class="btn btn-outline-secondary btn-sm border-0" href="#">
                      <i class="fas fa-trash fa-lg"
                        SameSite=None Secure></i></a>
                  </td>
                <% } %>
              </tr>
        <% }) %>
      </tbody>
    </table>
  </div>


<%- include ../partials/footer %>
